name: Unified AI Training & Content Pipeline

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      force_upload:
        description: 'Force upload to YouTube'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  train-create-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 400  # ~6.5 hours max
    permissions:
      contents: write
    
    env:
      SDL_VIDEODRIVER: dummy
      SDL_AUDIODRIVER: dummy
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      IMAGEMAGICK_BINARY: /usr/bin/convert
    
    steps:
    # ========== SETUP ==========
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pygame ffmpeg xvfb \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          imagemagick fonts-dejavu fonts-liberation
        sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    # ========== RESTORE STATE ==========
    - name: Download previous checkpoint
      continue-on-error: true
      run: |
        gh release download latest --pattern "neat-checkpoint-*" || echo "No checkpoint found"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Restore content state
      continue-on-error: true
      run: |
        # Download previous content state if exists
        gh release download latest --pattern ".content_state.json" || echo "No state file"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ========== TRAIN ==========
    - name: Generate car assets
      run: |
        echo "ðŸŽ¨ Generating car sprites..."
        xvfb-run -a python assets.py
    
    - name: Run AI Training
      run: |
        echo "ðŸ§  Starting training session..."
        xvfb-run -a python ai_brain.py
    
    # ========== GET INFO ==========
    - name: Get generation info
      id: gen_info
      run: |
        LATEST_CHECKPOINT=$(ls neat-checkpoint-* 2>/dev/null | sort -t'-' -k3 -n | tail -1)
        if [ -n "$LATEST_CHECKPOINT" ]; then
          GENERATION=$(echo "$LATEST_CHECKPOINT" | sed -n 's/neat-checkpoint-\([0-9]\+\).*/\1/p')
          echo "CHECKPOINT_FILE=$LATEST_CHECKPOINT" >> $GITHUB_ENV
          echo "GENERATION=$GENERATION" >> $GITHUB_ENV
          echo "checkpoint_exists=true" >> $GITHUB_OUTPUT
          echo "ðŸ§  Generation: $GENERATION"
        else
          echo "GENERATION=0" >> $GITHUB_ENV
          echo "checkpoint_exists=false" >> $GITHUB_OUTPUT
        fi
    
    # ========== CREATE CONTENT ==========
    - name: Create YouTube Shorts
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      run: |
        echo "ðŸŽ¬ Creating daily content..."
        python create_daily_shorts.py
        echo ""
        echo "ðŸ“ Videos created:"
        ls -lh daily_shorts/*.mp4 2>/dev/null || echo "No shorts created"
    
    # ========== UPLOAD TO YOUTUBE ==========
    - name: Upload to YouTube
      if: steps.gen_info.outputs.checkpoint_exists == 'true' || github.event.inputs.force_upload == 'true'
      continue-on-error: true
      run: |
        echo "ðŸ“¤ Uploading to YouTube..."
        
        # Upload each video with captions
        for video_file in daily_shorts/*.mp4; do
          if [ -f "$video_file" ]; then
            filename=$(basename "$video_file" .mp4)
            
            # Determine video type from filename
            if [[ "$filename" == *"training"* ]]; then
              TITLE="Day ${{ env.GENERATION }}: Training ðŸ’€ #Shorts #AI #Evolution"
              DESC="Watch AI learn from scratch! Day ${{ env.GENERATION }} of training. #Shorts #AI #MachineLearning #Racing"
            elif [[ "$filename" == *"pro"* ]]; then
              TITLE="Day ${{ env.GENERATION }}: Pro Level ðŸ† #Shorts #AI #Evolution"
              DESC="The AI has mastered it! Look at those clean lines! #Shorts #AI #Master #Perfect"
            elif [[ "$filename" == *"triple"* ]]; then
              TITLE="Day ${{ env.GENERATION }}: Complete Journey ðŸ“ˆ #Shorts #AI"
              DESC="Full evolution: Training â†’ Learning â†’ Pro in 60 seconds! #Shorts #AI #Evolution #Journey"
            else
              TITLE="Day ${{ env.GENERATION }}: AI Evolution #Shorts"
              DESC="AI learning to drive through evolution. Generation ${{ env.GENERATION }} #Shorts #AI"
            fi
            
            echo ""
            echo "ðŸŽ¬ Uploading: $filename"
            echo "   Title: $TITLE"
            
            # Upload with rich metadata
            python upload.py \
              --file "$video_file" \
              --title "$TITLE" \
              --description "$DESC" \
              --category "28" \
              --keywords "AI,machine learning,evolution,driving,racing,NEAT,genetic algorithm,training" \
              --privacyStatus "public" || echo "âš ï¸ Upload failed for $filename"
          fi
        done
        
        echo ""
        echo "âœ… Upload complete!"
    
    # ========== SAVE ARTIFACTS ==========
    - name: Upload training clips
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: training-clips-gen-${{ env.GENERATION }}
        path: training_clips/
        retention-days: 7
    
    - name: Upload daily shorts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-shorts-gen-${{ env.GENERATION }}
        path: daily_shorts/
        retention-days: 30
    
    - name: Upload checkpoint
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: checkpoint-gen-${{ env.GENERATION }}
        path: neat-checkpoint-*
        retention-days: 30
    
    # ========== SAVE STATE ==========
    - name: Save checkpoint to release
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      continue-on-error: true
      run: |
        gh release create latest --title "Latest Training State" --notes "Gen ${{ env.GENERATION }}" || true
        gh release upload latest ${{ env.CHECKPOINT_FILE }} --clobber
        # Also save content state
        if [ -f ".content_state.json" ]; then
          gh release upload latest .content_state.json --clobber || true
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Commit progress
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      run: |
        git config --global user.name "AI-Training-Bot"
        git config --global user.email "bot@ai-racing.com"
        
        # Keep only newest checkpoint
        ls -t neat-checkpoint-* | tail -n +2 | xargs -r rm --
        
        git add neat-checkpoint-* challenges.json theme.json .content_state.json 2>/dev/null || true
        
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ§  Gen ${{ env.GENERATION }} Evolution [skip ci]"
          git pull --rebase origin main
          git push
        fi
