name: Create YouTube Short (Manual)

on:
  workflow_dispatch:
    inputs:
      force_create:
        description: 'Force create video from latest clips'
        required: false
        type: boolean
        default: false

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg imagemagick fonts-dejavu
        sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download training clips from artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        path: training_clips/
        pattern: training-clips-*
        merge-multiple: true
    
    - name: Move clips to correct location
      run: |
        find training_clips/ -name "*.mp4" -exec mv {} training_clips/ \; 2>/dev/null || true
        rm -rf training_clips/training-clips-* 2>/dev/null || true
    
    - name: Create short
      run: |
        python render.py
    
    - name: Upload short
      uses: actions/upload-artifact@v4
      with:
        name: youtube-short-manual
        path: final_shorts/*.mp4
        retention-days: 30
        if-no-files-found: warn