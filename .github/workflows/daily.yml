name: Project Evolution Daily

on:
  schedule:
    - cron: '0 13,18,23 * * *'
  workflow_dispatch:

# üõ°Ô∏è CONCURRENCY PROTECTION
# Prevents race conditions. If a manual run starts while a schedule is running,
# it waits for the first one to finish saving instead of crashing.
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  run_evolution:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # CRITICAL: Allows bot to push changes (save brains)

    env:
      SDL_VIDEODRIVER: dummy 
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      IMAGEMAGICK_BINARY: /usr/bin/convert

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch full history for safer rebase

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # üõ†Ô∏è UPDATED: Added Fonts for the new Viral Text Overlays
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsdl2-dev imagemagick fonts-dejavu fonts-liberation
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml
          pip install --upgrade pip
          pip install -r requirements.txt

      # 1. GENERATE THEME (Colors/Physics)
      - name: Daily Config
        run: python daily_config.py

      # 2. PAINT ASSETS (Based on Theme)
      - name: Generate Assets
        run: python assets.py

      # 3. EVOLVE (Reads checkpoints, runs sim)
      - name: Run Simulation
        run: python ai_brain.py

      # 4. RENDER & UPLOAD
      - name: Edit & Upload
        run: python final_render.py

      # 5. PERSISTENCE (The Brain Saver + Rebase Fix)
      - name: Save Brain Progress
        run: |
          git config --global user.name "Auto-Evolution Bot"
          git config --global user.email "bot@factghost.com"
          
          # SMART CLEANUP: Keep only the newest checkpoint
          ls -t neat-checkpoint-* | tail -n +2 | xargs -r rm --
          
          # 1. Stage ONLY the files we want to save
          git add neat-checkpoint-*
          git add theme.json
          
          # 2. Check if there are changes to commit
          if git diff --staged --quiet; then
             echo "No changes to commit."
          else
             # 3. Create the Safe Save Point
             git commit -m "üß† Brain Evolution: Level Up [skip ci]"
             
             # 4. THE FIX: Wipe all other temporary changes (videos, cache, etc.)
             # This makes the directory "clean" so the rebase won't complain.
             git reset --hard HEAD
             
             # 5. NOW we can safely pull and push
             git pull --rebase origin main
             git push
          fi

      # 6. SAVE ARTIFACT (Download Video Manually)
      - name: Upload Video Artifact
        if: always() 
        # Run even if the YouTube upload failed
        uses: actions/upload-artifact@v4
        with:
          name: ai-evolution-video
          path: evolution_short.mp4
