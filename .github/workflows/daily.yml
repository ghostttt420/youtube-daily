name: Project Evolution Daily

on:
  push:
    branches:
      - refactor/professional-engineering  # Run on pushes to this branch
  schedule:
    - cron: "0 9,16,23 * * *"  # Run at 9am, 4pm, 11pm UTC
  workflow_dispatch:  # Allow manual runs

# Concurrency protection - prevent race conditions
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.11"
  SDL_VIDEODRIVER: dummy
  SDL_AUDIODRIVER: dummy
  IMAGEMAGICK_BINARY: /usr/bin/convert

jobs:
  run_evolution:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing checkpoints
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libsdl2-dev \
            imagemagick \
            fonts-dejavu \
            fonts-liberation
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml

      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Clean Old Data (Fresh Start)
        run: |
          # Remove old metrics database for fresh start
          rm -f data/metrics.db
          rm -rf data/ghosts/*
          rm -rf data/crashes/*
          rm -rf training_clips/*
          echo "âœ… Cleaned old data for fresh evolution"

      - name: Run Daily Pipeline (Enhanced)
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          ENV: production
          FEATURE_CURRICULUM: true
          FEATURE_WEATHER: true
          FEATURE_GHOST_CARS: true
          FEATURE_MULTI_OBJECTIVE: true
        run: |
          python -m src.cli daily

      - name: Cleanup Old Checkpoints
        run: |
          # Keep only the 5 most recent checkpoints to manage storage
          ls -t neat-checkpoint-* 2>/dev/null | tail -n +6 | xargs -r rm -f --

      - name: Persist Evolution State
        if: always()  # Run even if previous steps failed
        run: |
          git config --global user.name "Auto-Evolution Bot"
          git config --global user.email "bot@factghost.com"
          
          # Reset any unstaged changes to avoid conflicts
          git checkout -- . || true
          git clean -fd || true
          
          # Pull latest changes first (before committing)
          git pull --rebase --autostash origin ${{ github.ref_name }} || true
          
          # Stage checkpoint and theme
          git add neat-checkpoint-* 2>/dev/null || true
          git add theme.json 2>/dev/null || true
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ§  Brain Evolution: Daily Update [skip ci]"
            git pull --rebase --autostash origin ${{ github.ref_name }}
            git push
          else
            echo "No changes to commit"
          fi

      - name: Upload Video Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-evolution-video-${{ github.run_id }}
          path: evolution_short.mp4
          retention-days: 7

  notify:
    needs: run_evolution
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify on Failure
        run: |
          echo "::error::Daily evolution run failed!"
          echo "Check the workflow logs for details."
