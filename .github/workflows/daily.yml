name: Project Evolution Daily

on:
  schedule:
    - cron: '0 13,18,23 * * *'
  workflow_dispatch:

jobs:
  run_evolution:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # CRITICAL: Allows bot to push changes (save brains)

    env:
      SDL_VIDEODRIVER: dummy 
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      IMAGEMAGICK_BINARY: /usr/bin/convert

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsdl2-dev imagemagick
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml
          pip install --upgrade pip
          pip install -r requirements.txt

      # 1. GENERATE THEME (Colors/Physics)
      - name: Daily Config
        run: python daily_config.py

      # 2. PAINT ASSETS (Based on Theme)
      - name: Generate Assets
        run: python assets.py

      # 3. EVOLVE (Reads checkpoints, runs sim)
      - name: Run Simulation
        run: python ai_brain.py

      # 4. RENDER & UPLOAD
      - name: Edit & Upload
        run: python final_render.py

      # 5. PERSISTENCE (The Brain Saver)
      - name: Save Brain Progress
        run: |
          git config --global user.name "Auto-Evolution Bot"
          git config --global user.email "bot@factghost.com"
          
          # SMART CLEANUP:
          # Keep only the most recent checkpoint to save space
          # This command lists all checkpoints, sorts by time, keeps the newest, and deletes the rest
          ls -t neat-checkpoint-* | tail -n +2 | xargs -r rm --
          
          # Add the survivor (latest checkpoint)
          git add neat-checkpoint-*
          git add theme.json
          
          git commit -m "ðŸ§  Brain Evolution: Level Up [skip ci]" || echo "No changes to commit"
          git push

      # 6. SAVE ARTIFACT (Download Video Manually)
      - name: Upload Video Artifact
        if: always() 
        # Run even if the YouTube upload failed
        uses: actions/upload-artifact@v4
        with:
          name: ai-evolution-video
          path: evolution_short.mp4
