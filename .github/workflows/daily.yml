name: Daily AI Training

on:
  schedule:
    - cron: '0 2 * * *'  # Run at 2 AM UTC daily
  workflow_dispatch:  # Allow manual trigger

# Prevents race conditions
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    permissions:
      contents: write  # Allows pushing checkpoints and challenge updates
    
    env:
      SDL_VIDEODRIVER: dummy
      SDL_AUDIODRIVER: dummy
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      IMAGEMAGICK_BINARY: /usr/bin/convert
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pygame \
          ffmpeg \
          xvfb \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          imagemagick \
          fonts-dejavu \
          fonts-liberation
        sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download previous checkpoint (if exists)
      continue-on-error: true
      run: |
        gh release download latest --pattern "neat-checkpoint-*" || echo "No previous checkpoint found"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Run training
      run: |
        xvfb-run -a python ai_brain.py
    
    - name: Get generation info
      id: gen_info
      run: |
        # Sort checkpoints by generation number (not modification time)
        LATEST_CHECKPOINT=$(ls neat-checkpoint-* 2>/dev/null | sort -t'-' -k3 -n | tail -1)
        if [ -n "$LATEST_CHECKPOINT" ]; then
          # Extract generation number from filename like "neat-checkpoint-530"
          GENERATION=$(echo "$LATEST_CHECKPOINT" | sed -n 's/neat-checkpoint-\([0-9]\+\).*/\1/p')
          # Fallback to regex if sed doesn't match
          if [ -z "$GENERATION" ]; then
            GENERATION=$(echo "$LATEST_CHECKPOINT" | grep -oP '\d+$')
          fi
          echo "CHECKPOINT_FILE=$LATEST_CHECKPOINT" >> $GITHUB_ENV
          echo "GENERATION=$GENERATION" >> $GITHUB_ENV
          echo "checkpoint_exists=true" >> $GITHUB_OUTPUT
          echo "Detected generation: $GENERATION from $LATEST_CHECKPOINT"
        else
          echo "CHECKPOINT_FILE=none" >> $GITHUB_ENV
          echo "GENERATION=0" >> $GITHUB_ENV
          echo "checkpoint_exists=false" >> $GITHUB_OUTPUT
          echo "No checkpoint found"
        fi
    
    - name: Upload checkpoint as artifact
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: checkpoint-gen-${{ env.GENERATION }}
        path: neat-checkpoint-*
        retention-days: 30
    
    - name: Prepare training clips for upload
      if: always()
      run: |
        if [ -d "training_clips" ] && [ "$(find training_clips -name "*.mp4" | wc -l)" -gt 0 ]; then
          echo "Found training clips to upload"
          find training_clips -name "*.mp4" -exec echo "  {}" \;
        else
          echo "No training clips found (no milestones hit this run)"
          mkdir -p training_clips
          echo "No clips recorded this session" > training_clips/README.txt
        fi
    
    - name: Upload training clips
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: training-clips-gen-${{ env.GENERATION }}
        path: training_clips/
        retention-days: 30
    
    - name: Check if challenge completed
      id: challenge_check
      continue-on-error: true
      run: |
        COMPLETED=$(python -c "
        from challenge_loader import ChallengeLoader
        loader = ChallengeLoader()
        challenge = loader.get_last_completed_challenge()
        print('true' if challenge else 'false')
        " 2>/dev/null || echo "false")
        echo "challenge_completed=$COMPLETED" >> $GITHUB_OUTPUT
        echo "Challenge completed status: $COMPLETED"
    
    - name: Create video if challenge completed
      if: steps.challenge_check.outputs.challenge_completed == 'true'
      continue-on-error: true
      run: |
        python render.py || echo "âš ï¸ Video creation failed"
    
    - name: Check for video output
      id: video_check
      if: steps.challenge_check.outputs.challenge_completed == 'true'
      run: |
        if [ -d "final_shorts" ] && [ "$(find final_shorts -name "*.mp4" | wc -l)" -gt 0 ]; then
          echo "video_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… Video file found"
          find final_shorts -name "*.mp4" -exec echo "  {}" \;
        else
          echo "video_exists=false" >> $GITHUB_OUTPUT
          echo "âŒ No video file found"
        fi
    
    - name: Upload video artifact
      if: steps.challenge_check.outputs.challenge_completed == 'true' && steps.video_check.outputs.video_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: youtube-short-gen-${{ env.GENERATION }}
        path: final_shorts/
        retention-days: 30
    
    - name: Upload to YouTube (if challenge video created)
      if: steps.challenge_check.outputs.challenge_completed == 'true' && steps.video_check.outputs.video_exists == 'true'
      continue-on-error: true
      run: |
        # Get video title from challenge
        VIDEO_TITLE=$(python -c "
        from challenge_loader import ChallengeLoader
        loader = ChallengeLoader()
        challenge = loader.get_last_completed_challenge()
        print(challenge['video_hook'] if challenge else 'AI Evolution Challenge Complete!')
        " 2>/dev/null || echo "AI Evolution Challenge Complete! ðŸ†")
        
        # Find the video file
        VIDEO_FILE=$(find final_shorts -name "*.mp4" | head -1)
        if [ -n "$VIDEO_FILE" ]; then
          echo "Uploading video file: $VIDEO_FILE"
          python upload.py \
            --file "$VIDEO_FILE" \
            --title "$VIDEO_TITLE #Shorts" \
            --description "Watch AI learn through evolution! #Shorts #AI #MachineLearning" \
            --category "28" \
            --keywords "AI,machine learning,NEAT,evolution,driving" \
            --privacyStatus "public"
        else
          echo "âŒ No video file found for upload"
        fi
      env:
        YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
        YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
        YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
    
    - name: Create 3 Daily YouTube Shorts
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      continue-on-error: true
      run: |
        echo "ðŸŽ¬ Creating 3 daily YouTube Shorts..."
        python create_daily_shorts.py
        
        echo ""
        echo "ðŸ“ Shorts created in daily_shorts/:"
        ls -la daily_shorts/*.mp4 2>/dev/null || echo "No shorts found"
    
    - name: Upload daily shorts as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-shorts-gen-${{ env.GENERATION }}
        path: daily_shorts/
        retention-days: 30
    
    - name: Upload Daily Shorts to YouTube
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      continue-on-error: true
      run: |
        echo "ðŸ“¤ Uploading 3 daily shorts to YouTube..."
        
        # Upload each short
        SHORT_COUNT=0
        for video_file in daily_shorts/*.mp4; do
          if [ -f "$video_file" ]; then
            SHORT_COUNT=$((SHORT_COUNT + 1))
            
            # Extract video type from filename (struggle/progress/mastery)
            video_type=$(basename "$video_file" | cut -d'_' -f2)
            
            # Get challenge info
            CHALLENGE_NAME=$(python3 -c "from challenge_loader import ChallengeLoader; loader = ChallengeLoader(); challenge = loader.get_active_challenge(); print(challenge['name'] if challenge else 'AI Training')" 2>/dev/null || echo "AI Training")
            
            # Set title based on type
            case "$video_type" in
              "struggle")
                TITLE="Day ${GENERATION}: The Struggle ðŸ’€ $CHALLENGE_NAME #Shorts"
                DESC="Watch AI fail spectacularly! This is only the beginning... #Shorts #AI #Fail"
                ;;
              "progress")
                TITLE="Day ${GENERATION}: Getting Better ðŸ“ˆ $CHALLENGE_NAME #Shorts"
                DESC="The AI is learning! Can you see the improvement? #Shorts #AI #Progress"
                ;;
              "mastery")
                TITLE="Day ${GENERATION}: MASTERY! ðŸ† $CHALLENGE_NAME #Shorts"
                DESC="The AI has evolved! From chaos to perfection ðŸ§  #Shorts #AI #Evolution"
                ;;
              *)
                TITLE="Day ${GENERATION}: $CHALLENGE_NAME #Shorts"
                DESC="AI learning progress - Gen ${GENERATION} #Shorts #AI"
                ;;
            esac
            
            echo ""
            echo "ðŸŽ¬ Uploading Short #$SHORT_COUNT: $video_file"
            echo "   Title: $TITLE"
            
            python upload.py \
              --file "$video_file" \
              --title "$TITLE" \
              --description "$DESC" \
              --category "28" \
              --keywords "AI,machine learning,NEAT,evolution,driving,daily" \
              --privacyStatus "public" || echo "âš ï¸ Upload failed for $video_file"
          fi
        done
        
        if [ $SHORT_COUNT -eq 0 ]; then
          echo "âŒ No shorts found to upload"
        else
          echo ""
          echo "âœ… Uploaded $SHORT_COUNT daily shorts!"
          echo "ðŸ’¡ Tip: Space these out manually (9am, 3pm, 9pm) for maximum engagement"
        fi
      env:
        YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
        YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
        YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
    
    - name: Save checkpoint to release
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      continue-on-error: true
      run: |
        gh release create latest --title "Latest Training State" --notes "Generation ${{ env.GENERATION }}" || true
        gh release upload latest ${{ env.CHECKPOINT_FILE }} --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Save progress (Brain + Challenges)
      if: steps.gen_info.outputs.checkpoint_exists == 'true'
      run: |
        git config --global user.name "Auto-Evolution Bot"
        git config --global user.email "bot@factghost.com"
        
        # Keep only newest checkpoint
        ls -t neat-checkpoint-* | tail -n +2 | xargs -r rm --
        
        # Stage files we want to save
        git add neat-checkpoint-* 2>/dev/null || true
        git add challenges.json
        git add theme.json
        
        # Commit if changes exist
        if git diff --staged --quiet; then
           echo "No changes to commit."
        else
           git commit -m "ðŸ§  Brain Evolution Gen ${{ env.GENERATION }} [skip ci]"
           git reset --hard HEAD
           git pull --rebase origin main
           git push
        fi
