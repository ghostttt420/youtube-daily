name: Project Evolution Daily

on:
  schedule:
    - cron: '0 9,15,21 * * *'
  workflow_dispatch:

jobs:
  run_evolution:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # CRITICAL: Allows bot to push changes (save brains)

    env:
      SDL_VIDEODRIVER: dummy 
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      IMAGEMAGICK_BINARY: /usr/bin/convert

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsdl2-dev imagemagick
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml
          pip install --upgrade pip
          pip install -r requirements.txt

      # 1. GENERATE THEME (Colors/Physics)
      - name: Daily Config
        run: python daily_config.py

      # 2. PAINT ASSETS (Based on Theme)
      - name: Generate Assets
        run: python assets.py

      - name: WIPE OLD MEMORY (Hard Reset)
        run: rm -f neat-checkpoint-* best.pickle theme.json


      # 3. EVOLVE (Reads checkpoints, runs sim)
      - name: Run Simulation
        run: python ai_brain.py

      # 4. RENDER & UPLOAD
      - name: Edit & Upload
        run: python final_render.py

      # 5. PERSISTENCE (Save the Brain!)
      - name: Save Brain Progress
        run: |
          git config --global user.name "Auto-Evolution Bot"
          git config --global user.email "bot@factghost.com"
          
          # Add new checkpoints and theme
          git add neat-checkpoint-*
          git add theme.json
          
          # Clean up old clips to keep repo light (optional but recommended)
          # git rm training_clips/*.mp4 --ignore-unmatch
          
          git commit -m "ðŸ§  Brain Evolution: Gen Update [skip ci]" || echo "No changes to commit"
          git push
